// ë©€í‹° ëª¨ë“ˆ ë°©ì‹ìœ¼ë¡œ ì„¤ê³„(í”ŒëŸ¬ê·¸ì¸ì€ ë£¨íŠ¸ì—ì„œëŠ” ì„ ì–¸ë§Œ í•˜ê³  í•˜ìœ„ì—ì„œ ì‚¬ìš©í•¨)
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.1.3' apply false        // ğŸš€ Spring Boot í”ŒëŸ¬ê·¸ì¸
    id 'io.spring.dependency-management' version '1.1.3' apply false // ğŸ“¦ ì˜ì¡´ì„± ê´€ë¦¬ í”ŒëŸ¬ê·¸ì¸
    id 'com.google.cloud.tools.jib' version '3.4.0' apply false      // ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œìš© í”ŒëŸ¬ê·¸ì¸
}

// ğŸ› ï¸ ê³µí†µ ì„¤ì • ë³€ìˆ˜ ì •ì˜
ext {
    springBootVersion = '3.1.3'
    springDependencyManagementVersion = '1.1.3'
    jibPluginVersion = '3.4.0'
    javaVersion = JavaVersion.VERSION_17
    projectVersion = '1.0.0'
}

// ğŸ·ï¸ ê·¸ë£¹ ID ë° ë²„ì „
group = 'com.lsy'
version = projectVersion

// â˜• Java ë²„ì „ ì„¤ì •
java {
    sourceCompatibility = javaVersion
    targetCompatibility = javaVersion
}

// ğŸŒ ì˜ì¡´ì„± ì €ì¥ì†Œ (ëª¨ë“  ëª¨ë“ˆ ê³µí†µ)
repositories {
    mavenCentral()
}

// ğŸ“ í•˜ìœ„ ëª¨ë“ˆ ê³µí†µ ì„¤ì •
subprojects {
    // ë£¨íŠ¸ í”ŒëŸ¬ê·¸ì¸ ì ìš©
    apply plugin: 'java'
    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'
    apply plugin: 'com.google.cloud.tools.jib'
    // subprojectsì—ì„œ ì„ ì–¸ ì‹œ ë£¨íŠ¸ì˜ ì €ì¥ì†Œë¥¼ ë®ì–´ì”€(ì´ê²Œ ìš°ì„ ìˆœìœ„ê°€ ë¨)
    repositories {
        mavenCentral()
    }

    configurations {
        compileOnly {
            extendsFrom annotationProcessor
        }
    }

    java {
        sourceCompatibility = javaVersion
        targetCompatibility = javaVersion
    }

    // í•˜ìœ„ ëª¨ë“ˆì— ê³µí†µìœ¼ë¡œ ì ìš©ë˜ëŠ” ì˜ì¡´ì„±ë“¤
    dependencies {

        implementation 'org.springframework.boot:spring-boot-starter-web'
         // lombok
        compileOnly 'org.projectlombok:lombok'
        annotationProcessor 'org.projectlombok:lombok'
        annotationProcessor "org.springframework.boot:spring-boot-configuration-processor"

        testImplementation 'org.springframework.boot:spring-boot-starter-test'
        testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
    }

    tasks.named('test') {
        useJUnitPlatform()
    }
}

// api-common ëª¨ë“ˆ ì„¤ì •
project(':api-common') {
    // ì¼ë°˜ JARì€ ìƒì„± (ë‹¤ë¥¸ ëª¨ë“ˆì—ì„œ ê³µí†µ ì½”ë“œ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡)
    jar.enabled = true
    // ì‹¤í–‰ ê°€ëŠ¥í•œ Spring Boot JARì€ ìƒì„±í•˜ì§€ ì•ŠìŒ
    bootJar.enabled = false

    // âœ… ê³µí†µ ëª¨ë“ˆì€ ì‹¤í–‰ë˜ì§€ ì•Šìœ¼ë©°, ì»´íŒŒì¼ ì‹œ í•„ìš”í•œ ì˜ì¡´ì„±ë§Œ ì„ ì–¸í•©ë‹ˆë‹¤.
    // â€» ì‹¤ì œ ëŸ°íƒ€ì„ ì˜ì¡´ì„±ì€ ì´ ëª¨ë“ˆì„ ì‚¬ìš©í•˜ëŠ” ìª½ì—ì„œ ë°˜ë“œì‹œ ëª…ì‹œí•´ì•¼ í•©ë‹ˆë‹¤.
    dependencies {
        // Spring MVC ê´€ë ¨
        compileOnly 'org.springframework:spring-webmvc'

        // í”„ë¡œí¼í‹° ë°”ì¸ë”© ìë™ ì™„ì„± ë° ê²€ì¦ì„ ìœ„í•œ Configuration Processor
        annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'

        // Tomcat (ë‚´ì¥ ì„œë¸”ë¦¿ ì»¨í…Œì´ë„ˆ í•„ìš” ì‹œ)
        compileOnly 'org.apache.tomcat.embed:tomcat-embed-core'

        // ë¡œê¹… ì¸í„°í˜ì´ìŠ¤  (êµ¬í˜„ì²´ëŠ” ì‚¬ìš©í•˜ëŠ” ëª¨ë“ˆì—ì„œ logback ë“±ìœ¼ë¡œ êµ¬ì„±)
        compileOnly 'org.slf4j:slf4j-api'

        // Jasypt (ì•”í˜¸í™”/ë³µí˜¸í™” ë¼ì´ë¸ŒëŸ¬ë¦¬)
        compileOnly 'com.github.ulisesbocchio:jasypt-spring-boot-starter:3.0.5'

        // aop ì„¤ì •
        compileOnly 'org.springframework:spring-aop'

        // ê³µí†µ ìœ í‹¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ë¬¸ìì—´ ì²˜ë¦¬, íŒŒì¼ ë“±)
        compileOnly 'org.apache.commons:commons-lang3'
        compileOnly 'commons-io:commons-io:2.11.0'

        // Redis ì—°ë™ ê´€ë ¨ ìœ í‹¸ ì •ì˜ ì‹œ
        compileOnly 'org.springframework.boot:spring-boot-starter-data-redis:3.2.4'
        compileOnly 'io.lettuce:lettuce-core:6.3.2.RELEASE'

        // ìœ íš¨ì„± ê²€ì¦ ê´€ë ¨ ê³µí†µ ë¡œì§ ì‘ì„± ì‹œ
        compileOnly 'org.springframework.boot:spring-boot-starter-validation'
    }
}

// API ì„œë¹„ìŠ¤ ëª¨ë“ˆ(ì¶”í›„ file-api, auth-api ë“± ê³„ì† ì¶”ê°€í•´ì„œ ê³µí†µì ìœ¼ë¡œ ì ìš© ì˜ˆì •)
def apiModules = [
        project(':menu-api'),
        //project(':file-api')...
]
// API ì„œë¹„ìŠ¤ ëª¨ë“ˆì— ê³µí†µìœ¼ë¡œ ì ìš©
configure(apiModules) {
    jar.enabled = false
    bootJar.enabled = true

    dependencies {

        implementation 'org.springframework.boot:spring-boot-starter-web'

        implementation 'org.springframework.boot:spring-boot-starter-data-jdbc'
        implementation 'org.springframework.boot:spring-boot-starter-data-jpa'

        // ë¡œê¹…
        implementation 'org.slf4j:slf4j-api'

        // Jasypt (ì•”í˜¸í™”/ë³µí˜¸í™” ë¼ì´ë¸ŒëŸ¬ë¦¬)
        implementation 'com.github.ulisesbocchio:jasypt-spring-boot-starter:3.0.5'

        // ê³µí†µ ìœ í‹¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ë¬¸ìì—´ ì²˜ë¦¬, íŒŒì¼ ë“±)
        implementation 'org.apache.commons:commons-lang3'
        implementation 'commons-io:commons-io:2.11.0'

        // querydsl
        implementation 'com.querydsl:querydsl-jpa:5.0.0:jakarta'
        annotationProcessor "com.querydsl:querydsl-apt:5.0.0:jakarta"
        annotationProcessor "jakarta.annotation:jakarta.annotation-api"
        annotationProcessor "jakarta.persistence:jakarta.persistence-api"

        // querydsl ë¡œê·¸(add Param)
        implementation 'com.github.gavlyukovskiy:p6spy-spring-boot-starter:1.9.0'

        // ìœ íš¨ì„± ê²€ì¦ ê´€ë ¨ ê³µí†µ ë¡œì§ ì‘ì„± ì‹œ
        implementation 'org.springframework.boot:spring-boot-starter-validation'

        // redis
        implementation 'org.springframework.boot:spring-boot-starter-data-redis:3.2.4'
        implementation 'io.lettuce:lettuce-core:6.3.2.RELEASE'

        // aop ì„¤ì •
        implementation 'org.springframework:spring-aop'

        // postgresql
        implementation 'org.postgresql:postgresql:42.6.0'

        // swagger
        implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.0.2'

        // ê³µí†µ ëª¨ë“ˆ ì°¸ì¡°
        implementation project(':api-common')
    }

    def querydslDir = '$buildDir/generated/querydsl'

    // java source set ì— Querydsl Q Class ìœ„ì¹˜ ì¶”ê°€
    sourceSets {
        main.java.srcDirs += [ querydslDir ]
    }

    configurations {
        compileOnly {
            extendsFrom annotationProcessor
        }
    }

    // ìƒì„±ëœ Q Classê°€ ì»´íŒŒì¼ë  ë””ë ‰í† ë¦¬ ì„¤ì •
    tasks.withType(JavaCompile).configureEach {
        options.getGeneratedSourceOutputDirectory().set(file(querydslDir))
    }

    // gradle clean ì‹œ, Q Classê°€ ìœ„ì¹˜í•œ ë””ë ‰í† ë¦¬ ì‚­ì œ
    clean.doLast {
        file(querydslDir).deleteDir()
    }
}
